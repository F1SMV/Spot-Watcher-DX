<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL DX v2.2 - YELLOW OPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #0e0e0e;
            --text-main: #a0a0a0;
            --accent: #00f3ff;
            --alert: #ff003c;
            --border: 1px solid #333;
            --wl-bg: #ffeb3b; /* Jaune vif */
            --wl-text: #000000;
        }
        
        /* THEMES */
        body.matrix { --accent: #0f0; --bg-color: #000; --text-main: #0f0; }
        body.amber { --accent: #ffae00; --bg-color: #1a1000; --text-main: #d4a017; }
        body.neon { --accent: #ff00ff; --bg-color: #0a000a; --text-main: #ffccff; }
        
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Share Tech Mono', monospace; margin: 0; overflow-x: hidden; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #000; border-bottom: 1px solid #222; }
        h1 { font-family: 'Orbitron', sans-serif; color: var(--accent); margin: 0; font-size: 1.4rem; text-shadow: 0 0 10px var(--accent); }
        
        /* TICKER */
        .ticker-wrap {
            width: 100%; overflow: hidden; background-color: #111; border-bottom: 1px solid var(--accent);
            height: 30px; line-height: 30px; position: relative;
        }
        .ticker-move { display: inline-block; white-space: nowrap; animation: ticker 45s linear infinite; padding-left: 100%; }
        .ticker-item { display: inline-block; padding: 0 2rem; color: var(--accent); font-weight: bold; font-size: 1.1em; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* COMMAND DECK */
        .command-deck {
            display: flex; align-items: center; gap: 15px; background: #080808; padding: 10px 20px; border-bottom: 1px solid #333; flex-wrap: wrap;
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        select, input, button {
            background: #000; border: 1px solid var(--accent); color: var(--accent); padding: 5px 10px; font-family: 'Share Tech Mono'; cursor: pointer; outline: none;
        }
        button:hover { background: var(--accent); color: #000; }
        
        /* WATCHLIST TAGS */
        #watchlist-container { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .watchlist-item { background: var(--wl-bg); color: var(--wl-text); padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; cursor: pointer; border: 1px solid #444; font-weight: bold; }
        .watchlist-item:hover { background: var(--alert); color: #fff; }

        /* SECTORS LAYOUT */
        .sector-container { margin-bottom: 40px; border-bottom: 2px dashed #333; padding-bottom: 20px; }
        
        .sector-title {
            background: #111; color: #fff; padding: 8px 20px; font-family: 'Orbitron'; 
            border-top: 1px solid var(--accent); border-bottom: 1px solid var(--accent);
            margin-top: 0; display: flex; align-items: center; gap: 15px; font-size: 1.2rem;
        }
        .hf-style .sector-title { border-color: #e67e22; color: #e67e22; }
        .vhf-style .sector-title { border-color: #e84393; color: #e84393; }

        /* GRID SYSTEM */
        .main-grid {
            display: grid; grid-template-columns: 65% 35%; gap: 10px; padding: 10px;
            height: 45vh; min-height: 400px;
        }
        .secondary-grid {
            display: grid; grid-template-columns: 50% 50%; gap: 10px; padding: 0 10px 10px 10px;
            height: 35vh; min-height: 300px;
        }

        .panel { background: var(--panel-bg); border: var(--border); padding: 0; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel h3 { margin: 0; padding: 8px; background: #151515; font-size: 0.9rem; border-bottom: 1px solid #333; color: #ddd; }
        
        .map-wrapper { height: 100%; width: 100%; }
        .chart-wrapper { position: relative; flex: 1; padding: 10px; min-height: 0; }

        .scroll-list { flex: 1; overflow-y: auto; font-size: 0.85rem; scrollbar-width: thin; scrollbar-color: var(--accent) #000; }
        
        /* SPOT ROWS */
        .spot-row { 
            display: grid; 
            grid-template-columns: 70px 60px 100px auto; 
            gap: 10px; 
            padding: 4px 8px; 
            border-bottom: 1px solid #222; 
            align-items: center;
        }
        .spot-row:hover { background: #1a1a1a; color: #fff; }
        
        /* STYLE WATCHLIST MATCH (JAUNE) */
        .spot-row.watched {
            background-color: var(--wl-bg) !important;
            color: var(--wl-text) !important;
            font-weight: bold;
            border: 1px solid #fff;
        }
        .spot-row.watched .spot-freq, 
        .spot-row.watched .spot-call, 
        .spot-row.watched .spot-country { color: var(--wl-text) !important; }

        .spot-freq { color: var(--accent); text-align: right; font-family: monospace; }
        .spot-band { text-align: center; border-radius: 3px; color: #000; font-weight: bold; font-size: 0.8rem; padding: 1px 0; }
        .spot-call { font-weight: bold; color: #fff; letter-spacing: 1px; }
        .spot-country { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #888; }

        /* ALERTS */
        .surge-banner { display: none; background: var(--alert); color: #fff; font-size: 0.8rem; padding: 2px 8px; border-radius: 2px; animation: blink 1s infinite; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body>

<header>
    <h1>NEURAL DX <span style="font-size:0.6em; opacity:0.7; color:#fff">{{ version }}</span></h1>
    <div class="control-group">
        <button onclick="toggleTheme()">THEME</button>
        <button onclick="toggleVoice()">VOICE: <span id="voice-status">OFF</span></button>
    </div>
</header>

<!-- TICKER -->
<div class="ticker-wrap">
    <div class="ticker-move" id="ticker-content">
        <div class="ticker-item">INITIALISATION DU SYSTEME...</div>
    </div>
</div>

<!-- COMMAND DECK -->
<div class="command-deck">
    <div class="control-group">
        <span>FILTERS:</span>
        <select id="filter-band" onchange="updateData()">
            <option value="All">All Bands</option>
            {% for b in hf_bands + vhf_bands %}
            <option value="{{ b }}">{{ b }}</option>
            {% endfor %}
        </select>
        <select id="filter-mode" onchange="updateData()">
            <option value="All">All Modes</option>
            <option value="CW">CW</option>
            <option value="SSB">SSB</option>
            <option value="FT8">FT8</option>
            <option value="FT4">FT4</option>
            <option value="FM">FM</option>
            <option value="SSTV">SSTV</option>
        </select>
    </div>
    <div class="control-group" style="margin-left: auto; border-left: 1px solid #333; padding-left: 20px;">
        <span>WATCHLIST:</span>
        <input type="text" id="wl-input" placeholder="Call..." style="width: 70px; text-transform: uppercase;">
        <button onclick="addToWatchlist()">ADD</button>
        <div id="watchlist-container"></div>
    </div>
</div>

<!-- ================= HF SECTOR (Inclut 6m) ================= -->
<div class="sector-container hf-style">
    <div class="sector-title">
        üì° HF GLOBAL & MAGIC BAND (160m - 6m) 
        <span id="hf-surge-alert" class="surge-banner">‚ö†Ô∏è SURGE</span>
    </div>
    
    <div class="main-grid">
        <div class="panel">
            <div id="map-hf" class="map-wrapper"></div>
        </div>
        <div class="panel">
            <h3>üèÜ TOP DX WANTED</h3>
            <div id="wanted-hf" class="scroll-list"></div>
        </div>
    </div>

    <div class="secondary-grid">
        <div class="panel">
            <h3>üåä LIVE STREAM</h3>
            <div id="list-hf" class="scroll-list"></div>
        </div>
        <div class="panel">
            <h3>üìä ACTIVITY</h3>
            <div class="chart-wrapper">
                <canvas id="chart-hf"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ================= VHF SECTOR ================= -->
<div class="sector-container vhf-style">
    <div class="sector-title">
        üõ∞Ô∏è VHF / UHF / SPACE 
        <span id="vhf-surge-alert" class="surge-banner">‚ö†Ô∏è SURGE</span>
    </div>
    
    <div class="main-grid">
        <div class="panel">
            <div id="map-vhf" class="map-wrapper"></div>
        </div>
        <div class="panel">
            <h3>üöÄ TOP VHF WANTED</h3>
            <div id="wanted-vhf" class="scroll-list"></div>
        </div>
    </div>

    <div class="secondary-grid">
        <div class="panel">
            <h3>üåä LIVE STREAM</h3>
            <div id="list-vhf" class="scroll-list"></div>
        </div>
        <div class="panel">
            <h3>üìä ACTIVITY</h3>
            <div class="chart-wrapper">
                <canvas id="chart-vhf"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const BAND_COLORS = {{ band_colors|tojson }};
    const HF_BANDS = {{ hf_bands|tojson }};
    const VHF_BANDS = {{ vhf_bands|tojson }};

    const mapHF = L.map('map-hf', { attributionControl: false }).setView([25, 0], 2);
    const mapVHF = L.map('map-vhf', { attributionControl: false }).setView([48, 10], 3);

    const tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    L.tileLayer(tileUrl, { maxZoom: 19 }).addTo(mapHF);
    L.tileLayer(tileUrl, { maxZoom: 19 }).addTo(mapVHF);

    let markersHF = [], markersVHF = [];
    let voiceEnabled = false;
    let watchlist = [];
    let lastTickerText = "";

    // Charts
    const commonOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { 
            y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666', font: {size: 9} } }, 
            x: { grid: { color: '#222' }, ticks: { color: '#888', font: {size: 9} } } 
        },
        animation: false
    };

    function createChart(id, labels) {
        const ctx = document.getElementById(id).getContext('2d');
        const bgColors = labels.map(b => BAND_COLORS[b] || '#555');
        return new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ data: [], backgroundColor: bgColors, borderRadius: 2 }] },
            options: commonOptions
        });
    }

    const chartHF = createChart('chart-hf', HF_BANDS);
    const chartVHF = createChart('chart-vhf', VHF_BANDS);

    // UI Utils
    const themes = ['', 'matrix', 'amber', 'neon'];
    let currentTheme = 0;
    function toggleTheme() {
        currentTheme = (currentTheme + 1) % themes.length;
        document.body.className = themes[currentTheme];
    }

    function toggleVoice() {
        voiceEnabled = !voiceEnabled;
        document.getElementById('voice-status').innerText = voiceEnabled ? "ON" : "OFF";
        if(voiceEnabled) speak("Voice systems online.");
    }

    function speak(text) {
        if (!voiceEnabled) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US'; u.rate = 1.2; u.pitch = 0.9;
        window.speechSynthesis.speak(u);
    }

    // Watchlist
    async function loadWatchlist() {
        const r = await fetch('/watchlist.json');
        watchlist = await r.json();
        const container = document.getElementById('watchlist-container');
        container.innerHTML = watchlist.map(c => 
            `<span class="watchlist-item" onclick="removeFromWatchlist('${c}')">${c} &times;</span>`
        ).join('');
    }

    async function addToWatchlist() {
        const input = document.getElementById('wl-input');
        const call = input.value.trim().toUpperCase();
        if(!call) return;
        await fetch('/watchlist.json', { method: 'POST', body: JSON.stringify({call: call}) });
        input.value = ''; loadWatchlist();
    }

    async function removeFromWatchlist(call) {
        await fetch('/watchlist.json', { method: 'DELETE', body: JSON.stringify({call: call}) });
        loadWatchlist();
    }

    // Render Row (Updated with Yellow Highlight)
    function createSpotRow(s) {
        const isWatched = watchlist.includes(s.dx_call);
        const rowClass = isWatched ? 'spot-row watched' : 'spot-row';
        
        return `
            <div class="${rowClass}">
                <span class="spot-freq">${s.freq}</span>
                <span class="spot-band" style="background:${s.color}">${s.band}</span>
                <span class="spot-call">${s.dx_call}</span>
                <span class="spot-country">${s.country}</span>
            </div>`;
    }

    function createWantedRow(s) {
        return `
            <div class="spot-row" style="border-left: 3px solid ${s.color}">
                <span class="spot-freq" style="color:#666">${s.score}pts</span>
                <span class="spot-band" style="background:${s.color}">${s.band}</span>
                <span class="spot-call">${s.dx_call}</span>
                <span class="spot-country">${s.country}</span>
            </div>`;
    }

    // Main Loop
    async function updateData() {
        const fBand = document.getElementById('filter-band').value;
        const fMode = document.getElementById('filter-mode').value;
        
        try {
            const [rSpots, rWanted, rSurge, rRss] = await Promise.all([
                fetch(`/spots.json?band=${fBand}&mode=${fMode}`),
                fetch('/wanted.json'),
                fetch('/surge.json'),
                fetch('/rss.json')
            ]);

            const spots = await rSpots.json();
            const wanted = await rWanted.json();
            const surge = await rSurge.json();
            const rss = await rRss.json();

            // RSS Update
            if (rss.ticker !== lastTickerText) {
                document.getElementById('ticker-content').innerHTML = `<div class="ticker-item">${rss.ticker}</div>`;
                lastTickerText = rss.ticker;
            }

            // Clear
            document.getElementById('list-hf').innerHTML = '';
            document.getElementById('list-vhf').innerHTML = '';
            markersHF.forEach(m => mapHF.removeLayer(m)); markersHF = [];
            markersVHF.forEach(m => mapVHF.removeLayer(m)); markersVHF = [];
            
            const statsHF = {}, statsVHF = {};

            // Process Spots
            spots.forEach(s => {
                if(fBand !== 'All' && s.band !== fBand) return;
                if(fMode !== 'All' && s.mode !== fMode) return;

                // Note: Backend sends type based on list inclusion. Since we moved 6m to HF list in backend,
                // s.type will be 'HF' for 6m spots automatically.
                const isVHF = s.type === 'VHF';
                const targetList = isVHF ? 'list-vhf' : 'list-hf';
                const targetMap = isVHF ? mapVHF : mapHF;

                document.getElementById(targetList).insertAdjacentHTML('beforeend', createSpotRow(s));

                const m = L.circleMarker([s.lat, s.lon], {
                    radius: 4, color: s.color, fillColor: s.color, fillOpacity: 0.9, weight: 1
                }).bindPopup(`<b>${s.dx_call}</b><br>${s.freq} (${s.mode})<br>${s.country}`);
                
                m.addTo(targetMap);
                if(isVHF) markersVHF.push(m); else markersHF.push(m);

                if(isVHF) statsVHF[s.band] = (statsVHF[s.band] || 0) + 1;
                else statsHF[s.band] = (statsHF[s.band] || 0) + 1;

                if (watchlist.includes(s.dx_call) && (Date.now()/1000 - s.timestamp) < 10) {
                    speak(`Alert. Watchlist target ${s.dx_call} spotted on ${s.band}`);
                }
            });

            // Charts
            chartHF.data.datasets[0].data = HF_BANDS.map(b => statsHF[b] || 0);
            chartHF.update();
            chartVHF.data.datasets[0].data = VHF_BANDS.map(b => statsVHF[b] || 0);
            chartVHF.update();

            // Wanted
            document.getElementById('wanted-hf').innerHTML = wanted.hf.map(createWantedRow).join('');
            document.getElementById('wanted-vhf').innerHTML = wanted.vhf.map(createWantedRow).join('');

            // Updated Surge Logic (Display Specific Bands)
            const hfSurges = surge.surges.filter(b => HF_BANDS.includes(b));
            const vhfSurges = surge.surges.filter(b => VHF_BANDS.includes(b));
            
            const hfAlert = document.getElementById('hf-surge-alert');
            if(hfSurges.length > 0) {
                hfAlert.innerText = "‚ö†Ô∏è SURGE: " + hfSurges.join(', ');
                hfAlert.style.display = 'inline-block';
            } else { hfAlert.style.display = 'none'; }

            const vhfAlert = document.getElementById('vhf-surge-alert');
            if(vhfSurges.length > 0) {
                vhfAlert.innerText = "‚ö†Ô∏è SURGE: " + vhfSurges.join(', ');
                vhfAlert.style.display = 'inline-block';
            } else { vhfAlert.style.display = 'none'; }

            if((hfSurges.length || vhfSurges.length) && voiceEnabled && Math.random() > 0.9) speak("Propagation alert.");

        } catch(e) { console.error(e); }
    }

    loadWatchlist();
    setInterval(updateData, 3000);
    updateData();

</script>
</body>
</html>
