<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radio Spot Watcher — Map</title>
<link rel="stylesheet" href="/static/base.css">

<script>
(function () {
  const theme =
    localStorage.getItem('theme') ||
    localStorage.getItem('selectedTheme') ||
    localStorage.getItem('themeName');
  if (!theme) return;
  document.documentElement.setAttribute('data-theme', theme);
  window.addEventListener('DOMContentLoaded', () => {
    document.body.setAttribute('data-theme', theme);
  });
})();
</script>

  <!-- Leaflet + plugins (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>

/* === Theme variables (from dashboard) === */
:root{
--bg-color: #050505;
            --panel-bg: #0e0e0e;
            --text-main: #a0a0a0;
            --accent: #00f3ff;
            --alert: #ff003c; /* Rouge vif pour Surge */
            --border: 1px solid #333;
            --wl-bg: #ffeb3b;
            --wl-text: #000000;
            --open-color: #d35400;
}
html[data-theme='dark'], body[data-theme='dark']{
--bg-color: #1a1a1a;
            --panel-bg: #2a2a2a;
            --text-main: #f0f0f0;
            --accent: #00ff80;
            --alert: #ff6347;
            --border: 1px solid #555;
            --wl-bg: #ffff00;
            --wl-text: #000000;
            --open-color: #ffd700;
}
html[data-theme='matrix'], body[data-theme='matrix']{
--bg-color: #000000;
            --panel-bg: #031503;
            --text-main: #00ff41; /* Vert Matrix */
            --accent: #00ff41;
            --alert: #ff004c;
            --border: 1px solid #005500;
            --wl-bg: #4cff7e;
            --wl-text: #000000;
            --open-color: #00aa00;
}
html[data-theme='sunset'], body[data-theme='sunset']{
--bg-color: #2b0c3d;
            --panel-bg: #4a1961;
            --text-main: #f0e6ff;
            --accent: #ff9900; /* Orange coucher de soleil */
            --alert: #ff3366;
            --border: 1px solid #7c4d9e;
            --wl-bg: #ffcc66;
            --wl-text: #2b0c3d;
            --open-color: #ff66a3;
}

/* === Map variable mapping === */
:root{
  --bg: var(--bg-color);
  --panel: var(--panel-bg);
  --panel2: var(--panel-bg);
  --text: color-mix(in srgb, var(--text-main) 70%, #888 30%);
  --text2: var(--text-main);
  --accent2: color-mix(in srgb, var(--accent) 18%, transparent);
  --danger: var(--alert);
  --shadow: 0 14px 40px rgba(0,0,0,.55);
  --radius: 16px;
}


    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(0,243,255,.10), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(255,0,60,.06), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:18px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border: var(--border, 1px solid rgba(255,255,255,.10));
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius); box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 6px rgba(0,243,255,.13);}
    .brand h1{font-size:16px;margin:0;color:var(--text2);letter-spacing:.3px}
    .brand .sub{font-size:12px;opacity:.9}
    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .nav a{
      color:var(--text2);text-decoration:none;font-size:13px;
      padding:8px 10px;border: var(--border, 1px solid rgba(255,255,255,.10));
      background:rgba(255,255,255,.03);
      border-radius:12px;
    }
    .nav a:hover{border-color:rgba(0,243,255,.45); box-shadow:0 0 0 4px rgba(0,243,255,.08)}
    .nav a.active{border-color:rgba(0,243,255,.55); background:rgba(0,243,255,.08)}

    .grid{display:grid; grid-template-columns: 420px 1fr; gap:16px; margin-top:16px;}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr;} }

    .panel{
      border: var(--border, 1px solid rgba(255,255,255,.10));
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px;
      border-bottom: var(--border, 1px solid rgba(255,255,255,.10));
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .title{color:var(--text2);font-weight:900;font-size:13px;letter-spacing:.25px}
    .bd{padding:14px}

    .pillrow{display:flex;flex-wrap:wrap;gap:10px}
    .pill{
      border: var(--border, 1px solid rgba(255,255,255,.10));
      background: rgba(0,243,255,.06);
      border-radius:14px;
      padding:10px 12px;
      min-width: 120px;
    }
    .pill .k{font-size:11px;opacity:.9}
    .pill .v{font-size:16px;color:var(--text2);font-weight:900;margin-top:4px}

    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .row{grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;opacity:.95;display:block;margin:0 0 6px 2px}
    select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border: var(--border, 1px solid rgba(255,255,255,.10));
      background:rgba(255,255,255,.03);
      color:var(--text2);
      outline:none;
    }
    select:focus{border-color:rgba(0,243,255,.55); box-shadow:0 0 0 4px rgba(0,243,255,.08)}
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,243,255,.40);
      background:rgba(0,243,255,.10);
      color:var(--text2);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn.secondary{border-color:var(--border);background:rgba(255,255,255,.03);font-weight:700}

    .toggles{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .toggle{
      border: var(--border, 1px solid rgba(255,255,255,.10));
      background:rgba(255,255,255,.03);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--text2);
      cursor:pointer;
      user-select:none;
    }
    .toggle.on{
      border-color:rgba(0,243,255,.60);
      background:rgba(0,243,255,.12);
      box-shadow:0 0 0 4px rgba(0,243,255,.06);
    }

    .status{
      margin-top:12px;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .status code{
      padding:6px 8px;
      border-radius:10px;
      border: var(--border, 1px solid rgba(255,255,255,.10));
      background:rgba(255,255,255,.02);
      color:var(--text2);
    }
    #explain{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border: 1px solid color-mix(in srgb, var(--accent) 35%, transparent);
      background:rgba(0,243,255,.06);
      color:var(--text2);
      font-size:12px;
      line-height:1.4;
    }

    .mapwrap{padding:14px;position:relative}
    #map{width:100%; height: calc(100vh - 150px); min-height: 720px; border-radius: var(--radius);}
    #overlayErr{
      display:none;
      position:absolute; inset:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,0,60,.55);
      background: rgba(255,0,60,.08);
      color: var(--text2);
      padding:14px;
      font-size:13px;
      line-height:1.35;
      pointer-events:none;
      white-space:pre-wrap;
    }

    /* Leaflet popup theming */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background: rgba(10,18,32,.96);
      color: var(--text2);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
    }
    .leaflet-popup-content{margin:10px 12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Radio Spot Watcher — Map</h1>
          <div class="sub">{{ my_call }} · {{ version }} · QTH {{ user_qra }}</div>
        </div>
      </div>
      <div class="nav">
        <a href="/" class="btn secondary">Dashboard</a>
        <a href="/map" class="btn active">Map</a>
        <a href="/analysis.html" class="btn secondary">Analysis</a>
        <a href="/world" class="btn secondary">World</a>
        <a href="/briefing" class="btn secondary">Briefing</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="hd">
          <div class="title">V4 · Modes A + C (au choix)</div>
          <div style="font-size:12px;opacity:.85">Heat(bande) / Cercles</div>
        </div>
        <div class="bd">
          <div class="pillrow">
            <div class="pill"><div class="k">SFI</div><div class="v" id="sfi">N/A</div></div>
            <div class="pill"><div class="k">A-index</div><div class="v" id="aidx">N/A</div></div>
            <div class="pill"><div class="k">K / Kp</div><div class="v" id="kidx">N/A</div></div>
          </div>

          <div class="controls">
            <div>
              <label for="minutes">Fenêtre</label>
              <select id="minutes">
                <option value="5">5 min</option>
                <option value="15" selected>15 min</option>
                <option value="60">60 min</option>
                <option value="180">3 h</option>
              </select>
            </div>
            <div>
              <label for="limit">Limite spots</label>
              <select id="limit">
                <option value="350">350</option>
                <option value="600" selected>600</option>
                <option value="1200">1200</option>
                <option value="3000">3000</option>
              </select>
            </div>

            <div>
              <label for="band">Bande</label>
              <select id="band">
                <option value="">Toutes</option>
                <option value="160m">160m</option><option value="80m">80m</option><option value="60m">60m</option>
                <option value="40m">40m</option><option value="30m">30m</option><option value="20m">20m</option>
                <option value="17m">17m</option><option value="15m">15m</option><option value="12m">12m</option>
                <option value="10m">10m</option><option value="6m">6m</option>
                <option value="4m">4m</option><option value="2m">2m</option><option value="70cm">70cm</option>
                <option value="23cm">23cm</option><option value="13cm">13cm</option><option value="QO-100">QO-100</option>
              </select>
            </div>
            <div>
              <label for="mode">Mode</label>
              <select id="mode">
                <option value="">Tous</option>
                <option value="CW">CW</option>
                <option value="SSB">SSB</option>
                <option value="FT8">FT8</option>
                <option value="FT4">FT4</option>
                <option value="FM">FM</option>
                <option value="RTTY">RTTY</option>
                <option value="MSK144">MSK144</option>
                <option value="SSTV">SSTV</option>
              </select>
            </div>

            <div class="row">
              <button class="btn" id="refresh">Refresh</button>
              <button class="btn secondary" id="recenter">Recentrer</button>
            </div>
          </div>

          <div class="toggles">
            <div class="toggle on" id="t_cluster">Cluster: ON</div>
            <div class="toggle on" id="t_points">Points: ON</div>
            <div class="toggle" id="t_heat">Heat (bande): OFF</div>
            <div class="toggle" id="t_circles">Cercles: OFF</div>
            <div class="toggle on" id="t_auto">Auto: ON</div>
          </div>

          <div class="status">
            <div>Spots: <code id="count">0</code> · Dernier: <code id="last">—</code></div>
            <div><code id="diag">OK</code></div>
          </div>

          <div id="explain"></div>

          <!-- Spot manuel (comme dashboard) -->
          <div style="margin-top:12px;padding:12px;border-radius:14px;border: 1px solid color-mix(in srgb, var(--accent) 35%, transparent);background:rgba(255,255,255,.02);">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div style="color:var(--text2);font-weight:900;font-size:13px">Spot manuel</div>
              <code id="spot_status" style="padding:6px 8px;border-radius:10px;border: var(--border, 1px solid rgba(255,255,255,.10));background:rgba(255,255,255,.02);color:var(--text2);">—</code>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
              <div>
                <label for="m_freq">Fréquence (MHz ou kHz)</label>
                <input id="m_freq" type="text" placeholder="14.074 ou 14074.0" style="width:100%;padding:10px;border-radius:12px;border: var(--border, 1px solid rgba(255,255,255,.10));background:rgba(255,255,255,.03);color:var(--text2);outline:none">
              </div>
              <div>
                <label for="m_call">Indicatif</label>
                <input id="m_call" type="text" placeholder="K1ABC" style="width:100%;padding:10px;border-radius:12px;border: var(--border, 1px solid rgba(255,255,255,.10));background:rgba(255,255,255,.03);color:var(--text2);outline:none">
              </div>
              <div style="grid-column:1 / -1">
                <label for="m_comment">Commentaire</label>
                <input id="m_comment" type="text" placeholder="FT8 / CQ / IOTA / ..." style="width:100%;padding:10px;border-radius:12px;border: var(--border, 1px solid rgba(255,255,255,.10));background:rgba(255,255,255,.03);color:var(--text2);outline:none">
              </div>
              <div style="grid-column:1 / -1;display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" id="m_send">Envoyer au cluster</button>
                <button class="btn secondary" id="m_fill">Remplir depuis le dernier spot cliqué</button>
              </div>
            </div>

            <div style="margin-top:10px;font-size:12px;opacity:.85;line-height:1.35">
              Envoie une commande <code>DX</code> au cluster via <code>/api/spot</code>. Si ça répond “Cluster not connected”, c’est juste que le telnet n’est pas connecté.
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hd"><div class="title">Carte</div><div style="font-size:12px;opacity:.85">Points / Heat / Cercles</div></div>
        <div class="mapwrap">
          <div id="map"></div>
          <div id="overlayErr"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <script>
    const BAND_COLORS = {
      "160m":"#5c4b51","80m":"#8e44ad","60m":"#2c3e50","40m":"#2980b9","30m":"#16a085",
      "20m":"#27ae60","17m":"#f1c40f","15m":"#e67e22","12m":"#d35400","10m":"#c0392b",
      "6m":"#e84393","4m":"#ff9ff3","2m":"#f1c40f","70cm":"#c0392b","23cm":"#8e44ad",
      "13cm":"#bdc3c7","QO-100":"#00a8ff"
    };

    let showCluster=true, showPoints=true, showHeat=false, showCircles=false, autoRefresh=true;

    let map, clusterLayer, pointsLayer, heatLayer, circlesLayer;
    let lastSpots = [];
    let lastClickedSpot = null;

    const overlay = document.getElementById('overlayErr');
    function showOverlay(msg){ overlay.style.display='block'; overlay.textContent = msg; }
    function hideOverlay(){ overlay.style.display='none'; overlay.textContent=''; }

    function setDiag(t,bad=false){
      const el=document.getElementById('diag');
      el.textContent=t;
      el.style.borderColor = bad ? "rgba(255,0,60,.55)" : "rgba(255,255,255,.10)";
      el.style.background  = bad ? "rgba(255,0,60,.08)" : "rgba(255,255,255,.02)";
    }

    function fmt(x,d=0){
      if(x===null||x===undefined||x==="") return "N/A";
      const n=Number(x); if(Number.isNaN(n)) return String(x);
      return n.toFixed(d);
    }

    function syncToggleLabels(){
      document.getElementById('t_cluster').textContent = "Cluster: " + (showCluster ? "ON" : "OFF");
      document.getElementById('t_points').textContent  = "Points: "  + (showPoints  ? "ON" : "OFF");
      document.getElementById('t_heat').textContent    = "Heat (bande): " + (showHeat ? "ON" : "OFF");
      document.getElementById('t_circles').textContent = "Cercles: " + (showCircles ? "ON" : "OFF");
      document.getElementById('t_auto').textContent    = "Auto: "    + (autoRefresh ? "ON" : "OFF");
    }

    function syncExplain(){
      const band = document.getElementById('band').value;
      const el = document.getElementById('explain');
      if(!el) return;

      if(showHeat){
        el.innerHTML =
          "<b>Mode A — Heatmap (bande)</b><br>" +
          "<span style='opacity:.92'>Actif uniquement si tu choisis une bande (actuel : <b>" + (band||"—") + "</b>). " +
          "Affiche les zones d'activité sur la fenêtre choisie. 15 min = ouverture en cours.</span>";
      } else if(showCircles){
        el.innerHTML =
          "<b>Mode C — Cercles</b><br>" +
          "<span style='opacity:.92'>Rend l'activité lisible même avec très peu de spots. " +
          "Couleur = bande. Chaque spot dessine une zone autour de lui (sans mentir sur la densité).</span>";
      } else {
        el.innerHTML =
          "<b>Mode points</b><br>" +
          "<span style='opacity:.92'>Affichage spot par spot (couleur = bande). " +
          "Active <b>Cercles</b> quand il y a peu de spots, ou <b>Heat (bande)</b> si tu analyses une bande précise.</span>";
      }
    }

    function applyVis(){
      if(map.hasLayer(clusterLayer)) map.removeLayer(clusterLayer);
      if(map.hasLayer(pointsLayer)) map.removeLayer(pointsLayer);
      if(map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
      if(map.hasLayer(circlesLayer)) map.removeLayer(circlesLayer);

      if(showPoints){
        if(showCluster) map.addLayer(clusterLayer);
        else map.addLayer(pointsLayer);
      }
      if(showHeat) map.addLayer(heatLayer);
      if(showCircles) map.addLayer(circlesLayer);
    }

    function initMap(){
      if(typeof L === 'undefined'){
        showOverlay("Leaflet non chargé.\nCause probable : pas d'accès internet (CDN) ou DNS.\nSolution : mettre Leaflet en local dans /static/.");
        return false;
      }
      hideOverlay();
      map = L.map('map', {worldCopyJump:true}).setView([43.1, 5.88], 3);
      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
         maxZoom: 18,
         attribution: "Tiles © Esri"
  }
).addTo(map);


      clusterLayer = L.markerClusterGroup({showCoverageOnHover:false, maxClusterRadius:50});
      pointsLayer = L.layerGroup();

      // Heatmap: tuned for visibility (but still needs density)
      heatLayer = L.heatLayer([], {
        radius: 55, blur: 35, maxZoom: 6, max: 1.0,
        gradient: {
          0.10:"#001018",
          0.30:"#004d66",
          0.50:"#00b3b3",
          0.70:"#ffcc00",
          0.85:"#ff6600",
          1.00:"#ff003c"
        }
      });

      circlesLayer = L.layerGroup();
      applyVis();
      return true;
    }

    async function loadSolar(){
      try{
        const r = await fetch('/api/solar.json', {cache:'no-store'});
        const j = await r.json();
        document.getElementById('sfi').textContent = j.sfi ?? "N/A";
        document.getElementById('aidx').textContent = j.a ?? "N/A";
        const k = (j.kp!==null && j.kp!==undefined && j.kp!=="") ? fmt(j.kp,2) : (j.k ?? "N/A");
        document.getElementById('kidx').textContent = k;
      }catch(e){}
    }

    
    function setSpotStatus(msg, bad=false){
      const el = document.getElementById('spot_status');
      if(!el) return;
      el.textContent = msg;
      el.style.borderColor = bad ? "rgba(255,0,60,.55)" : "rgba(0,243,255,.25)";
      el.style.background  = bad ? "rgba(255,0,60,.08)" : "rgba(0,243,255,.06)";
    }

    async function sendManualSpot(){
      const freq = (document.getElementById('m_freq')?.value || "").trim();
      const call = (document.getElementById('m_call')?.value || "").trim().toUpperCase();
      const comment = (document.getElementById('m_comment')?.value || "").trim();

      if(!freq || !call){
        setSpotStatus("freq/call ?", true);
        return;
      }
      setSpotStatus("envoi…", false);

      try{
        const r = await fetch('/api/spot', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({freq, call, comment})
        });
        const j = await r.json().catch(()=>null);
        if(r.ok && j && j.ok){
          setSpotStatus("OK", false);
        } else {
          const err = (j && j.error) ? j.error : ("HTTP " + r.status);
          setSpotStatus(err, true);
        }
      }catch(e){
        setSpotStatus("réseau", true);
      }
    }

    function fillManualFromLastClicked(){
      if(!lastClickedSpot){
        setSpotStatus("clic un spot", true);
        return;
      }
      if(document.getElementById('m_freq')) document.getElementById('m_freq').value = lastClickedSpot.freq || "";
      if(document.getElementById('m_call')) document.getElementById('m_call').value = lastClickedSpot.call || "";
      if(document.getElementById('m_comment')) document.getElementById('m_comment').value = lastClickedSpot.comment || "";
      setSpotStatus("pré-rempli", false);
    }

function markerForSpot(s){
      const band=s.band||"Unknown";
      const color=BAND_COLORS[band]||"#00f3ff";
      const spd=Number(s.score||0);
      const radius=Math.max(4, Math.min(12, 4+(spd/12)));
      const m=L.circleMarker([s.lat,s.lon], {radius, weight:2, color, fillColor:color, fillOpacity:0.40});
      m.bindPopup(
        `<b>${(s.dx_call||"")}</b> (${band} · ${(s.mode||"")})<br>`+
        `SPD: ${fmt(spd,0)} · Dist: ${fmt(s.distance_km,0)} km<br>`+
        `${(s.time||"")}`
      );
      m.on('click', ()=>{ lastClickedSpot = {freq: s.freq, call: s.dx_call, comment: (s.mode||'') + ' ' + (s.band||'')}; });
      return {m, spd, band, color};
    }

    function rebuildFromCache(){
      if(!map) return;

      clusterLayer.clearLayers();
      pointsLayer.clearLayers();
      circlesLayer.clearLayers();

      const heatPts = [];
      for(const s of lastSpots){
        const {m, spd, band, color} = markerForSpot(s);

        if(showPoints){
          if(showCluster) clusterLayer.addLayer(m);
          else pointsLayer.addLayer(m);
        }

        // Strong heat intensity mapping
        // SPD 40 -> 1.0, SPD 20 -> 0.6, SPD 10 -> 0.6 (floor)
        const inten = Math.min(1.0, Math.max(0.6, Number(spd||0) / 40));
        heatPts.push([s.lat, s.lon, inten]);

        if(showCircles){
          // Circle radius (meters) => readable even with low spot count
          // Uses distance_km if present; else fixed 320km.
          const dist = Number(s.distance_km || 0);
          const km = (dist && dist > 0) ? Math.max(220, Math.min(520, dist/10)) : 320;
          L.circle([s.lat, s.lon], {
            radius: km*1000,
            color: color,
            weight: 1,
            opacity: 0.9,
            fillColor: color,
            fillOpacity: 0.14
          }).addTo(circlesLayer);
        }
      }

      heatLayer.setLatLngs(heatPts);
      applyVis();
    }

    async function loadSpots(){
      if(!map) return;

      const minutes=document.getElementById('minutes').value;
      const limit=document.getElementById('limit').value;
      const band=document.getElementById('band').value;
      const mode=document.getElementById('mode').value;

      // Heatmap is band-only (Solution A)
      if(showHeat && !band){
        showHeat = false;
        document.getElementById('t_heat').classList.remove('on');
        syncToggleLabels();
        syncExplain();
        setDiag("Heat: choisir une bande", false);
      }

      const p=new URLSearchParams();
      p.set('minutes', minutes);
      p.set('limit', limit);
      if(band) p.set('band', band);
      if(mode) p.set('mode', mode);

      const url="/api/map/spots?"+p.toString();

      try{
        setDiag("Loading…");
        const r = await fetch(url, {cache:'no-store'});
        const j = await r.json();
        if(!j || !j.ok){ setDiag("API bad", true); return; }

        lastSpots = (j.spots||[]).filter(s => typeof s.lat==='number' && typeof s.lon==='number' && s.lat!==0 && s.lon!==0);

        document.getElementById('count').textContent=String(lastSpots.length);
        document.getElementById('last').textContent=new Date().toLocaleTimeString();

        rebuildFromCache();
        setDiag("OK");
      }catch(e){
        setDiag("Fetch failed", true);
        showOverlay("Erreur fetch spots.\nOuvre la console (F12) pour le détail.\n" + String(e));
      }
    }

    function toggle(el, setter, refetch=true){
      el.classList.toggle('on');
      setter(el.classList.contains('on'));
      syncToggleLabels();
      syncExplain();
      applyVis();

      if(refetch) loadSpots();
      else rebuildFromCache();
    }

    async function boot(){
      if(!initMap()) return;

      // Toggle handlers
      document.getElementById('t_cluster').addEventListener('click', (e)=>toggle(e.currentTarget, v=>showCluster=v, false));
      document.getElementById('t_points').addEventListener('click', (e)=>toggle(e.currentTarget, v=>showPoints=v, false));

      document.getElementById('t_heat').addEventListener('click', (e)=>{
        const band = document.getElementById('band').value;
        if(!band && !showHeat){
          setDiag("Heat: choisir une bande", false);
          // keep OFF
          return;
        }
        toggle(e.currentTarget, v=>showHeat=v, false);
      });

      document.getElementById('t_circles').addEventListener('click', (e)=>toggle(e.currentTarget, v=>showCircles=v, false));
      document.getElementById('t_auto').addEventListener('click', (e)=>toggle(e.currentTarget, v=>autoRefresh=v, false));

      document.getElementById('refresh').addEventListener('click', async ()=>{ await loadSolar(); await loadSpots(); });
      document.getElementById('recenter').addEventListener('click', ()=>map.setView([43.1,5.88],3,{animate:true}));

      // Spot manuel
      document.getElementById('m_send')?.addEventListener('click', (ev)=>{ ev.preventDefault(); sendManualSpot(); });
      document.getElementById('m_fill')?.addEventListener('click', (ev)=>{ ev.preventDefault(); fillManualFromLastClicked(); });
      setSpotStatus('—', false);

      for(const id of ["m_freq","m_call","m_comment"]){
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendManualSpot(); }});
        }
      }

      for(const id of ["minutes","limit","band","mode"]){
        document.getElementById(id).addEventListener('change', ()=>{ syncExplain(); loadSpots(); });
      }

      syncToggleLabels();
      syncExplain();

      await loadSolar();
      await loadSpots();

      setInterval(async ()=>{
        if(!autoRefresh) return;
        await loadSolar();
        await loadSpots();
      }, 15000);
    }

    boot();
  </script>
</body>
</html>
