<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>World Forecast ‚Äî Radio Spot Watcher DX v6</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="/static/base.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body[data-page="world"] { margin:0; overflow:hidden; }

.world-layout {
  display:grid;
  grid-template-columns:320px 1fr;
  height:calc(100vh - 48px);
}

@media (max-width: 900px) {
  .world-layout {
    grid-template-columns:1fr;
    grid-template-rows:auto 1fr;
  }

  .world-sidebar {
    border-bottom:1px solid #333;
  }

  .world-map {
    height:60vh;
  }
}

.world-sidebar {
  padding:16px;
  overflow-y:auto;
}

.world-map {
  position:relative;
}

#map {
  width:100%;
  height:100%;
}

.world-legend {
  position:absolute;
  bottom:12px;
  right:12px;
  pointer-events:none;
}
</style>
</head>

<body data-page="world">

<div class="topbar">
  <a href="/">Dashboard</a>
  <a href="/map">Map</a>
  <a href="/analysis">Analysis</a>
  <a href="/briefing">Briefing</a>
  <a href="/world"><b>World</b></a>
</div>

<div class="world-layout">

  <!-- SIDEBAR -->
  <aside class="world-sidebar panel">
    <h3>üåç World Forecast</h3>

    <label>Band</label>
    <select id="bandSelect">
      <option value="all">All HF</option>
      <option value="160m">160m</option>
      <option value="80m">80m</option>
      <option value="60m">60m</option>
      <option value="40m">40m</option>
      <option value="30m">30m</option>
      <option value="20m">20m</option>
      <option value="17m">17m</option>
      <option value="15m">15m</option>
      <option value="12m">12m</option>
      <option value="10m">10m</option>
    </select>

    <label>Time window (minutes)</label>
    <input type="range" id="windowRange" min="30" max="360" step="30" value="180">

    <label>
      <input type="checkbox" id="anomaliesOnly">
      confirmed anomalies only
    </label>

    <div id="world-status" class="muted">Initializing‚Ä¶</div>
    <div id="world-updated" class="muted"></div>

    <hr>
    <h4>üß† Comment lire cette carte ?</h4>
    <p>
      Cette vue <b>World</b> ne montre pas des stations individuelles,
      mais des <b>zones de propagation radio</b>.
    </p>
    <ul>
      <li><b>Cercles color√©s</b> : r√©gions coh√©rentes spatialement et temporellement</li>
      <li><span style="color:#ff3b3b">Rouge</span> : propagation confirm√©e</li>
      <li><span style="color:#ff9800">Orange</span> : propagation suspecte</li>
      <li><span style="color:#aaaaaa">Gris</span> : bruit / calibration</li>
    </ul>
    <p>
      Cette page aide √† <b>prendre une d√©cision</b>.
      Pour les stations exactes, utilisez <b>Map</b>.
    </p>

    <hr>
    <h4>üß† How to read this map</h4>
    <p>
      The <b>World</b> view shows <b>propagation zones</b>,
      not individual stations.
    </p>
    <ul>
      <li><span style="color:#ff3b3b">Red</span>: confirmed propagation</li>
      <li><span style="color:#ff9800">Orange</span>: suspect propagation</li>
      <li><span style="color:#aaaaaa">Grey</span>: background noise</li>
    </ul>
    <p>
      This page supports <b>decision making</b>.
      Use <b>Map</b> for raw spots.
    </p>
  </aside>

  <!-- MAP -->
  <main class="world-map">
    <div id="map"></div>

    <div class="world-legend panel">
      <div><span style="color:#ff3b3b">‚óè</span> confirmed</div>
      <div><span style="color:#ff9800">‚óè</span> suspect</div>
      <div><span style="color:#aaaaaa">‚óè</span> calibration</div>
    </div>
  </main>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* === STATE (restored) === */
const state = {
  band: 'all',
  window: 180,
  anomaliesOnly: false
};

const saved = localStorage.getItem("worldState");
if (saved) Object.assign(state, JSON.parse(saved));

/* === MAP INIT === */
const map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);

L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { maxZoom: 18 }
).addTo(map);

const clusterLayer = L.layerGroup().addTo(map);
const statusBox = document.getElementById('world-status');
const updatedBox = document.getElementById('world-updated');

/* === CONTROLS === */
bandSelect.value = state.band;
windowRange.value = state.window;
anomaliesOnly.checked = state.anomaliesOnly;

bandSelect.onchange = e => { state.band = e.target.value; refresh(); };
windowRange.oninput = e => { state.window = +e.target.value; refresh(); };
anomaliesOnly.onchange = e => { state.anomaliesOnly = e.target.checked; refresh(); };

/* === REFRESH === */
function refresh() {
  clusterLayer.clearLayers();
  statusBox.textContent = "Analysing propagation‚Ä¶";

  fetch(`/api/forecast/anomalies?band=${state.band}&window=${state.window}`)
    .then(r => r.json())
    .then(data => {
      const clusters = data.clusters || [];

      if (!clusters.length) {
        statusBox.textContent =
          "No coherent propagation detected in this time window.";
        updatedBox.textContent =
          "Last update: " + new Date().toUTCString();
        return;
      }

      statusBox.textContent =
        data.mode === "calibration"
          ? "Calibration in progress ‚Äî signals detected"
          : "Propagation anomalies detected";

      clusters.forEach(c => {
        if (!c.center) return;
        if (state.anomaliesOnly && c.status !== "confirmed") return;

        const color =
          c.status === "confirmed" ? "#ff3b3b" :
          c.status === "suspect"   ? "#ff9800" :
                                     "#aaaaaa";

        L.circle([c.center.lat, c.center.lon], {
          radius:
            c.status === "confirmed" ? 250000 :
            c.status === "suspect"   ? 150000 :
                                       80000,
          color,
          fillColor: color,
          weight: 1,
          fillOpacity: 0.35
        }).addTo(clusterLayer);
      });

      updatedBox.textContent =
        "Last update: " + new Date().toUTCString();

      localStorage.setItem("worldState", JSON.stringify(state));
      map.invalidateSize();
    })
    .catch(() => {
      statusBox.textContent = "Error loading forecast data.";
    });
}

setTimeout(() => map.invalidateSize(), 300);
refresh();
setInterval(refresh, 60000); // auto refresh 60s
</script>

</body>
</html>
