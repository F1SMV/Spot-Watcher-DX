<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/base.css">
    <title>NEURAL AI 6.0 - ANALYSE & PR√âDICTION</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
        

        /* --- THEMES IMPORTES DE index.html --- */
        :root {
            --bg-color: #050505;
            --panel-bg: #0e0e0e;
            --text-main: #a0a0a0;
            --accent: #00f3ff;
            --alert: #ff003c; /* Rouge vif pour Surge */
            --border: 1px solid #333;
            --wl-bg: #ffeb3b;
            --wl-text: #000000;
            --open-color: #d35400;
        }
        
        
        body[data-theme='light'] {
            --bg-color: #ffffff;
            --panel-bg: #ffffff;
            --text-main: #111111;
            --accent: #0066ff;
            --alert: #d50000;
            --border: 1px solid #d0d0d0;
            --wl-bg: #ffeb3b;
            --wl-text: #000000;
            --open-color: #d35400;
        }

        body[data-theme='dark'] {
            --bg-color: #1a1a1a;
            --panel-bg: #2a2a2a;
            --text-main: #f0f0f0;
            --accent: #00ff80;
            --alert: #ff6347;
            --border: 1px solid #555;
            --wl-bg: #ffff00;
            --wl-text: #000000;
            --open-color: #ffd700;
        }
        
        body[data-theme='matrix'] {
            --bg-color: #000000;
            --panel-bg: #031503;
            --text-main: #00ff41; /* Vert Matrix */
            --accent: #00ff41;
            --alert: #ff004c;
            --border: 1px solid #005500;
            --wl-bg: #4cff7e;
            --wl-text: #000000;
            --open-color: #00aa00;
        }
        
        body { background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-sans); margin: 0; padding: 20px; transition: all 0.3s; }
        
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; }
        h1 { font-family: var(--font-display); font-size: 1.2rem; color: var(--accent); margin: 0; text-transform: uppercase; letter-spacing: 1px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        
        /* --- PANEL & DRAG HANDLE --- */
        .panel { background: var(--panel-bg); border: var(--border); border-radius: 14px; padding: 15px; box-shadow: 0 10px 28px rgba(0,0,0,0.45); position: relative; display: flex; flex-direction: column; transition: box-shadow 0.3s; }
        .drag-handle { 
            position: absolute; top: 8px; left: 8px; cursor: grab; 
            width: 12px; height: 18px; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 2px; opacity: 0.3;
        }
        .drag-handle div { width: 3px; height: 3px; background-color: var(--text-main); border-radius: 50%; }
        .panel:hover .drag-handle { opacity: 0.8; }
        .panel:active { cursor: grabbing; }

        .panel-header { font-family: var(--font-display); font-size: 0.8rem; color: var(--accent); margin-bottom: 5px; margin-left: 20px; border-bottom: 1px solid #222; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        .explanation { font-size: 0.7rem; color: #777; font-style: italic; margin-bottom: 10px; line-height: 1.2; padding-left: 20px;}
        .explanation b { color: var(--accent); }

        .ai-briefing { background: rgba(0, 243, 255, 0.03); border-left: 3px solid var(--accent); padding: 12px; font-size: 0.95rem; color: #eee; margin-top: 10px; line-height: 1.4; }
        
        .stat-row { display: flex; justify-content: space-around; text-align: center; margin: 10px 0; }
        .stat-value { font-size: 1.6rem; font-weight: bold; color: var(--success); }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.7; }

        .list-container { max-height: 150px; overflow-y: auto; font-size: 0.8rem; border: 1px solid #111; padding: 5px; background: rgba(0,0,0,0.2); }
        .list-item { display: flex; justify-content: space-between; padding: 4px 5px; border-bottom: 1px solid #222; }
        
        .status-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; border: 1px solid var(--success); color: var(--success); font-weight: bold; }
        .badge-alert { border-color: var(--alert); color: var(--alert); }

        .btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 5px 12px; cursor: pointer; font-family: var(--font-display); font-size: 0.7rem; text-transform: uppercase; }
        .btn:hover { background: var(--accent); color: #000; }
        
        .grid-full { grid-column: 1 / -1; }
        canvas { width: 100% !important; max-height: 180px; }
    
        /* === V4.0 LOOK (FORC√â) : pav√©s tr√®s lisibles === */
        .panel{
            background: var(--panel-bg) !important;
            border: 1px solid rgba(255,255,255,0.22) !important;
            border-radius: 16px !important;
            box-shadow: 0 14px 34px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.06) inset !important;
            overflow: hidden !important;
        }
        body[data-theme='light'] .panel{
            border: 1px solid rgba(0,0,0,0.16) !important;
            box-shadow: 0 14px 30px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.80) inset !important;
        }
        body[data-theme='matrix'] .panel{
            border: 1px solid rgba(0,255,65,0.55) !important;
            box-shadow: 0 14px 36px rgba(0,0,0,0.70), 0 0 0 1px rgba(0,255,65,0.12) inset !important;
        }
        .panel-header{
            padding: 12px 16px !important;
            border-bottom: 1px solid rgba(255,255,255,0.14) !important;
            letter-spacing: .08em !important;
            text-transform: uppercase !important;
            font-weight: 900 !important;
        }
        body[data-theme='light'] .panel-header{
            border-bottom: 1px solid rgba(0,0,0,0.10) !important;
        }
        /* espace entre colonnes/pav√©s */
        .dashboard-grid, .grid, .container{
            gap: 14px !important;
        }

</style>
</head>
<body>
<header>
    <div>
        <h1>Neural AI Analysis Center</h1>
        <small id="sync-info">Sync Mode: Active</small>
    </div>
    <div style="display:flex; gap:8px;">
        <button class="btn" onclick="location.href='/map'">DX Map</button>
        <button class="btn" onclick="location.href='/'">Dashboard</button>
        <button class="btn" onclick="location.href='/world'">World</button>
        <button class="btn" onclick="location.href='/briefing'">Briefing</button>
    </div>
</header>

      <div class="dashboard-grid" id="sortable-dashboard">

        <div class="panel grid-full" data-id="ai-report">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header">
                <span>ü§ñ AI OPERATOR REPORT / RAPPORT IA</span>
                <span id="ai-status" class="status-badge">ACTIVE</span>
            </div>
            <div class="explanation">Tactical synthesis of ionospheric conditions. / <i>Synth√®se tactique des conditions ionosph√©riques.</i></div>
            <div id="ai-text-report" class="ai-briefing">Initializing neural correlation...</div>
        </div>


        <div class="panel grid-full" data-id="dx-briefing">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header">
                <span>üõ∞Ô∏è DX BRIEFING / BRIEFING DX</span>
                <span style="display:flex; gap:6px; align-items:center;">
                    <button id="dx-lang-fr" class="btn" style="padding:4px 8px;">FR</button>
                    <button id="dx-lang-en" class="btn" style="padding:4px 8px;">EN</button>
                    <button id="dx-refresh" class="btn" style="padding:4px 8px;">Refresh</button>
                </span>
            </div>
            <div class="explanation">
                Generated tactical summary from live stats + solar indices. /
                <i>Synth√®se tactique g√©n√©r√©e √† partir des stats et des indices solaires.</i>
            </div>
            <div id="dx-briefing-text" class="ai-briefing">Loading DX Briefing...</div>
            <div id="dx-briefing-meta" style="margin-top:8px; font-size:0.75rem; color:#8ef; opacity:0.9; padding-left:20px;"></div>
        </div>

        <div class="panel" data-id="stats-24h">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header">24H PERFORMANCE / PERFORMANCE 24H</div>
            <div class="explanation">Activity volume and prefix diversity. / <i>Volume d'activit√© et diversit√© des pr√©fixes.</i></div>
            <div class="stat-row">
                <div><div id="stat-dxcc" class="stat-value">--</div><div class="stat-label">DXCC</div></div>
                <div><div id="stat-rarity" class="stat-value">--</div><div class="stat-label">RARITY %</div></div>
                <div><div id="stat-spots" class="stat-value">--</div><div class="stat-label">SPOTS</div></div>
            </div>
        </div>

        <div class="panel" data-id="band-analysis">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header">BAND ANALYZER / ANALYSEUR DE BANDES</div>
            <div class="explanation">Distribution of spots by frequency. / <i>R√©partition des spots par fr√©quence.</i></div>
            <canvas id="bandChart"></canvas>
        </div>

        <div class="panel" data-id="anomaly-detector">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header">ANOMALY DETECTOR / D√âTECTEUR D'ANOMALIES</div>
            <div class="explanation">Detection of unusual propagation events. / <i>D√©tection d'√©v√®nements de propagation rares.</i></div>
            <div id="anomaly-list" class="list-container">
                <div class="list-item">Scanning spectrum...</div>
            </div>
        </div>

        <div class="panel" data-id="rare-entities">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header">RARE ENTITIES / ENTIT√âS RARES</div>
            <div class="explanation">Entities with high SPD scores (>70). / <i>Entit√©s √† haut score de raret√© SPD.</i></div>
            <div id="rare-list" class="list-container"></div>
        </div>

        <div class="panel" data-id="ld-calls">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header">LONG DISTANCE / TRAJETS DX (>10k km)</div>
            <div class="explanation">Stations spotted at extreme ranges. / <i>Stations re√ßues √† tr√®s longue distance.</i></div>
            <div id="ld-list" class="list-container"></div>
        </div>

    
        <div class="panel" data-id="meta-analyse" id="meta-panel">
            <div class="drag-handle"><div></div><div></div><div></div><div></div><div></div><div></div></div>
            <div class="panel-header" style="display:flex; justify-content:space-between; align-items:center;">
                <span>üìä META ANALYSE / META ANALYSIS</span>
                <span style="display:flex; gap:8px; align-items:center;">
                    <span class="status-badge" id="metaFreshBadge" title="Fra√Æcheur / Freshness">‚Äî</span>
                    <button class="btn" id="metaRunBtn" style="padding:4px 8px;" onclick="runMetaOncePerDay()" title="Relancer (1 fois / jour) / Run (once per day)">‚Üª RUN</button>
                </span>
            </div>
            <div class="explanation">
                FR: Synth√®se auto du log (volume, p√©riode, top DX SPD). / 
                <i>EN: Auto summary from log (volume, time range, top DX SPD).</i>
            </div>

            <div class="list-container" style="max-height:none;">
                <div class="list-item"><b>Spots</b><span id="metaSpots">‚Äî</span></div>
                <div class="list-item"><b>P√©riode</b><span id="metaRange">‚Äî</span></div>
                <div class="list-item"><b>G√©n√©r√©</b><span id="metaGeneratedAt">‚Äî</span></div>
                <div class="list-item"><b>Relance possible</b><span id="metaCountdown">‚Äî</span></div>
            </div>

            <div style="margin-top:10px; font-size:0.8rem; color:var(--accent); padding-left:20px; opacity:0.95;">
                Top DX (SPD)
            </div>
            <div id="metaTopList" class="list-container"></div>
        </div>

</div>

    <script>
        // --- COULEURS SYNCHRONIS√âES AVEC INDEX.HTML ---
        const BAND_COLORS = {
            '160m': '#4b0082', '80m': '#0000ff', '60m': '#00ced1', '40m': '#00ff00',
            '30m': '#adff2f', '20m': '#ffff00', '17m': '#ffa500', '15m': '#ff4500',
            '12m': '#ff0000', '10m': '#ff1493', '6m': '#8b0000', '2m': '#4b0082',
            '70cm': '#2f4f4f', 'QO-100': '#ffffff'
        };

        let bandChart;

        // --- MOTEUR IA (LOGIQUE TACTIQUE) ---
        
        // --- DX BRIEFING (API) ---
        let dxBriefingLang = (localStorage.getItem('dxBriefingLang') || 'fr');

        function setDXBriefingButtons() {
            const fr = document.getElementById('dx-lang-fr');
            const en = document.getElementById('dx-lang-en');
            if (!fr || !en) return;
            fr.style.opacity = (dxBriefingLang === 'fr') ? '1' : '0.5';
            en.style.opacity = (dxBriefingLang === 'en') ? '1' : '0.5';
        }

        async function loadDXBriefing(force=false) {
            const box = document.getElementById('dx-briefing-text');
            const meta = document.getElementById('dx-briefing-meta');
            if (!box) return;

            const url = `/api/dx_briefing.json?lang=${dxBriefingLang}` + (force ? '&force=1' : '');
            try {
                const r = await fetch(url, { cache: 'no-store' });
                if (!r.ok) throw new Error('dx_briefing HTTP ' + r.status);
                const d = await r.json();

                // Render text (server returns HTML-ready line breaks sometimes; keep safe-ish)
                box.innerHTML = (d.briefing || 'No briefing available.');

                const ts = d.generated_utc || d.updated_utc || d.ts || '';
                const conf = (d.confidence !== undefined && d.confidence !== null) ? ` ¬∑ Confidence: ${d.confidence}%` : '';
                meta.textContent = ts ? (`Updated: ${ts}${conf}`) : conf.replace(' ¬∑','');

            } catch (e) {
                box.innerHTML = "DX Briefing unavailable (API error).<br><i>Briefing DX indisponible (erreur API).</i>";
                if (meta) meta.textContent = '';
                console.error("DX Briefing error:", e);
            }
        }

        function initDXBriefingUI() {
            const fr = document.getElementById('dx-lang-fr');
            const en = document.getElementById('dx-lang-en');
            const rf = document.getElementById('dx-refresh');

            if (fr) fr.addEventListener('click', () => {
                dxBriefingLang = 'fr';
                localStorage.setItem('dxBriefingLang', dxBriefingLang);
                setDXBriefingButtons();
                loadDXBriefing(true);
            });
            if (en) en.addEventListener('click', () => {
                dxBriefingLang = 'en';
                localStorage.setItem('dxBriefingLang', dxBriefingLang);
                setDXBriefingButtons();
                loadDXBriefing(true);
            });
            if (rf) rf.addEventListener('click', () => loadDXBriefing(true));

            setDXBriefingButtons();
        }

function runAIAnalysis(stats, solar) {
            const reportEl = document.getElementById('ai-text-report');
            const statusEl = document.getElementById('ai-status');
            
            let sfi = parseInt(solar.sfi) || 0;
            let k = parseInt(solar.k) || 0;
            let rarity = parseFloat(stats.rarity_rate_percent) || 0;

            let report = "<strong>[CORRELATION REPORT]</strong><br>";

            if (sfi > 140) report += "‚òÄÔ∏è <b>High Solar Activity:</b> Band 10m-15m optimized. / <i>Flux solaire √©lev√© : Bandes 10m-15m optimales.</i><br>";
            if (k >= 4) {
                report += "‚ö†Ô∏è <b>Geomagnetic Warning:</b> High noise levels expected. / <i>Alerte G√©omagn√©tique : Niveaux de bruit √©lev√©s.</i><br>";
                statusEl.className = "status-badge badge-alert";
                statusEl.textContent = "DISTURBED";
            } else {
                statusEl.className = "status-badge";
                statusEl.textContent = "ACTIVE";
            }

            if (stats.long_distance_calls_count > 5) report += "üåé <b>DX Window:</b> Excellent long-path openings detected. / <i>Ouvertures Long Path d√©tect√©es.</i><br>";
            
            if (rarity > 15) report += "üíé <b>Rarity Peak:</b> Multiple rare prefixes active. / <i>Pic de raret√© : Plusieurs pr√©fixes rares actifs.</i><br>";

            if (k < 3 && sfi > 115) report += "üéØ <b>Recommendation:</b> Focus on CW/Digital for long-range DX. / <i>Focus sur CW/Digital pour le DX lointain.</i>";
            
            reportEl.innerHTML = report;
        }

        // --- R√âCUP√âRATION DONN√âES ---
        async function updateDashboard() {
            try {
                const [resStats, resSolar] = await Promise.all([
                    fetch('/dxcc_stats_24h.json'),
                    fetch('/solar.json')
                ]);
                const stats = await resStats.json();
                const solar = await resSolar.json();

                document.getElementById('stat-dxcc').textContent = stats.unique_dxcc_count;
                document.getElementById('stat-rarity').textContent = stats.rarity_rate_percent + "%";
                document.getElementById('stat-spots').textContent = stats.total_spots_24h;

                runAIAnalysis(stats, solar);
                renderBandChart(stats.dxcc_by_band);

                fillRareSpots('rare-list', stats.recent_rare_spots);
                fillList('ld-list', stats.long_distance_calls, 'DX');
                
                // Anomalies
                const anomalyContainer = document.getElementById('anomaly-list');
                anomalyContainer.innerHTML = "";

                // 6m: affichage uniquement si le dernier spot 6m date de moins de 2h
                const last6 = stats.last_6m || {};
                const last6Age = (last6.age_sec !== undefined && last6.age_sec !== null) ? parseInt(last6.age_sec) : null;
                const last6Time = last6.time || null;
                const last6Call = last6.call || null;
                const last6Freq = last6.freq || null;

                if (last6Age !== null && last6Age < 7200) {
                    const when = last6Time ? (' ‚Ä¢ ' + last6Time) : '';
                    const who = last6Call ? (' ‚Ä¢ ' + last6Call) : '';
                    const frq = last6Freq ? (' ‚Ä¢ ' + last6Freq) : '';
                    anomalyContainer.innerHTML += `<div class="list-item" style="color:var(--success)">[+] Sudden 6m activity${when}${who}${frq}</div>`;
                }

                // Solaire: garde-fou simple
                if (solar && parseFloat(solar.k) >= 4) {
                    anomalyContainer.innerHTML += '<div class="list-item" style="color:var(--alert)">[!] Geomagnetic activity (K‚â•4)</div>';
                }

if (anomalyContainer.innerHTML === "") anomalyContainer.innerHTML = '<div class="list-item">Ionosphere stable.</div>';

            } catch (err) { console.error("Update Error:", err); }
        }

        
        function fillRareSpots(id, items) {
            const container = document.getElementById(id);
            container.innerHTML = '';
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="list-item"><i>Aucune activit√© rare r√©cente.</i></div>';
                return;
            }
            for (const it of items) {
                const call = it.call || 'N/A';
                const time = it.time || '--:--';
                const freq = it.freq ? String(it.freq) : '';
                const band = it.band || '';
                const mode = it.mode || '';
                const suffix = [band, mode].filter(Boolean).join(' ');
                const ftxt = freq ? (' ‚Ä¢ ' + freq) : '';
                container.innerHTML += `<div class="list-item"><b>${call}</b> ‚Ä¢ ${time}${ftxt}${suffix ? ' ‚Ä¢ ' + suffix : ''}</div>`;
            }
        }

function fillList(id, items, tag) {
            const container = document.getElementById(id);
            container.innerHTML = items && items.length > 0 
                ? items.map(i => `<div class="list-item"><span>${i}</span><span style="color:var(--accent); font-weight:bold;">${tag}</span></div>`).join('')
                : '<div class="list-item" style="opacity:0.5;">No data available.</div>';
        }

        function renderBandChart(bandData) {
            const ctx = document.getElementById('bandChart').getContext('2d');
            const labels = Object.keys(bandData);
            const values = Object.values(bandData);
            
            // Appliquer les couleurs de index.html
            const backgroundColors = labels.map(label => BAND_COLORS[label] || '#555555');

            if (bandChart) {
                bandChart.data.labels = labels;
                bandChart.data.datasets[0].data = values;
                bandChart.data.datasets[0].backgroundColor = backgroundColors;
                bandChart.update();
            } else {
                bandChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: backgroundColors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: '#222' }, ticks: { color: '#666', font: { size: 10 } } },
                            y: { grid: { display: false }, ticks: { color: '#aaa', font: { size: 11 } } }
                        }
                    }
                });
            }
        }

        // --- INIT & THEME SYNC ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'softtech';
            document.body.setAttribute('data-theme', savedTheme);
        }

        function initSortable() {
            const grid = document.getElementById('sortable-dashboard');
            Sortable.create(grid, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: () => {
                    const order = Array.from(grid.children).map(p => p.getAttribute('data-id'));
                    localStorage.setItem('dx-analysis-pos', JSON.stringify(order));
                }
            });
            const savedOrder = JSON.parse(localStorage.getItem('dx-analysis-pos'));
            if (savedOrder) {
                savedOrder.forEach(id => {
                    const el = grid.querySelector(`[data-id="${id}"]`);
                    if (el) grid.appendChild(el);
                });
            }
        }

        
        // === META ANALYSE (manuel 1x/jour) ===
        const META_INTERVAL_SEC = 86400; // 24h
        let __metaGeneratedMs = null;

        function updateMetaCountdown(){
            const el = document.getElementById("metaCountdown");
            if(!el) return;
            const now = Date.now();

            const lastManual = Number(localStorage.getItem("meta_last_run_click_ms") || "0");
            const baseMs = lastManual || __metaGeneratedMs || 0;

            if(!baseMs){
                el.textContent = "Disponible / Available";
                el.style.color = "var(--accent)";
                return;
            }

            const nextMs = baseMs + (META_INTERVAL_SEC * 1000);
            if(now >= nextMs){
                el.textContent = "Disponible / Available";
                el.style.color = "var(--accent)";
            } else {
                const diff = Math.floor((nextMs - now) / 1000);
                const h = String(Math.floor(diff / 3600)).padStart(2,'0');
                const m = String(Math.floor((diff % 3600) / 60)).padStart(2,'0');
                const s = String(diff % 60).padStart(2,'0');
                el.textContent = `${h}:${m}:${s}`;
                el.style.color = "";
            }
        }

        function _metaSetRunButtonState(){
            const btn = document.getElementById("metaRunBtn");
            if(!btn) return;
            const last = Number(localStorage.getItem("meta_last_run_click_ms") || "0");
            const now  = Date.now();
            const DAY  = 24 * 60 * 60 * 1000;

            if(last && (now - last) < DAY){
                const remainSec = Math.ceil((DAY - (now - last)) / 1000);
                const hh = String(Math.floor(remainSec / 3600)).padStart(2,'0');
                const mm = String(Math.floor((remainSec % 3600) / 60)).padStart(2,'0');
                btn.disabled = true;
                btn.textContent = `‚Üª ${hh}:${mm}`;
            } else {
                btn.disabled = false;
                btn.textContent = "‚Üª RUN";
            }
        }

        async function runMetaOncePerDay(){
            _metaSetRunButtonState();
            const btn = document.getElementById("metaRunBtn");
            if(btn && btn.disabled) return;

            if(!confirm("Relancer la m√©ta-analyse maintenant ? / Run meta analysis now?")) return;

            try{
                if(btn){ btn.disabled = true; btn.textContent = "‚Üª ..."; }
                const r = await fetch("/api/meta/run", { method:"POST" });
                if(!r.ok){
                    alert("META run failed (HTTP " + r.status + ").");
                    if(btn){ btn.disabled = false; btn.textContent = "‚Üª RUN"; }
                    return;
                }
                localStorage.setItem("meta_last_run_click_ms", String(Date.now()));
                setTimeout(loadMeta, 1800);
            }catch(e){
                console.error("META run error:", e);
                alert("META error: " + e);
                if(btn){ btn.disabled = false; btn.textContent = "‚Üª RUN"; }
                return;
            }
            _metaSetRunButtonState();
        }

        async function loadMeta(){
            try{
                const r = await fetch("/api/meta/summary", { cache:"no-store" });
                if(!r.ok) return;
                const data = await r.json();

                const spotsEl = document.getElementById("metaSpots");
                const rangeEl = document.getElementById("metaRange");
                const genEl   = document.getElementById("metaGeneratedAt");
                const badgeEl = document.getElementById("metaFreshBadge");
                const listEl  = document.getElementById("metaTopList");

                if(spotsEl) spotsEl.textContent = (data.spots ?? "‚Äî");
                if(rangeEl){
                    if(data.range?.start && data.range?.end) rangeEl.textContent = `${data.range.start} ‚Üí ${data.range.end}`;
                    else rangeEl.textContent = "‚Äî";
                }

                const genRaw = data.generated_at || null;
                __metaGeneratedMs = genRaw ? new Date(genRaw).getTime() : null;
                if(genEl) genEl.textContent = genRaw ? String(genRaw).replace('T',' ').slice(0,19) : "‚Äî";

                if(badgeEl){
                    badgeEl.classList.remove("badge-alert");
                    if(!genRaw){
                        badgeEl.textContent = "INCONNU / UNKNOWN";
                    }else{
                        const ageMin = Math.floor(Math.max(0, (Date.now() - __metaGeneratedMs) / 60000));
                        badgeEl.textContent = (ageMin < 10) ? `FRAIS ${ageMin}m` : `ANALYSE ${ageMin}m`;
                        if(ageMin >= 60) badgeEl.classList.add("badge-alert");
                    }
                }

                if(listEl){
                    const top = (data.top_spots || []).slice(0,8);
                    if(top.length === 0){
                        listEl.innerHTML = '<div class="list-item"><i>Aucun top spot.</i></div>';
                    }else{
                        listEl.innerHTML = top.map(s => `<div class="list-item"><b>${s.dx}</b><span>SPD ${s.spd} ¬∑ ${s.band} ${s.mode}</span></div>`).join("");
                    }
                }

                updateMetaCountdown();
                _metaSetRunButtonState();
            }catch(e){
                console.error("Meta load error:", e);
            }
        }

document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initSortable();
            initDXBriefingUI();
            loadDXBriefing(false);
            updateDashboard();
            setInterval(updateDashboard, 30000);
            setInterval(updateMetaCountdown, 1000);
            setInterval(_metaSetRunButtonState, 60000);
            setInterval(() => loadDXBriefing(false), 600000);
        });
    </script>
</body>
</html>